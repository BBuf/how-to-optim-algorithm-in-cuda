# 0x0. å‰è¨€

SGLang ç›®å‰åœ¨å•æœºH200ä¸Šæ¨ç†DeepSeek V3/R1æ˜¯è·‘å¾—æœ€å¿«çš„å¤§æ¨¡å‹å¼€æºæ¨ç†æ¡†æ¶ï¼Œä¸è¿‡æ€§èƒ½å¿«æ…¢å…¶å®ä¹Ÿä¸æ˜¯ç‰¹åˆ«å¥½è¯´ï¼Œå› ä¸ºå„ä¸ªæ¡†æ¶éƒ½ä¸€ç›´å¤„äºä½ è¿½æˆ‘èµ¶çš„å¿«é€Ÿä¼˜åŒ–ä¸­ã€‚æˆ‘è¿™é‡Œä»å¼€æºæŠ€æœ¯åˆ†äº«çš„è§’åº¦æ¥ç›˜ç‚¹ä¸€ä¸‹SGLangå¯¹å•æœºè§„æ¨¡æ¨ç†çš„å¤§é‡å·¥ç¨‹ä¼˜åŒ–æŠ€å·§ï¼Œè¿™é‡Œæ¶‰åŠçš„æŠ€å·§å…¶å®ä¹Ÿæ˜¯æˆ‘åœ¨å‚ä¸SGLangå¼€å‘ä¸­éšæ—¶è®°å½•ä¸‹çš„ï¼Œè‡ªå·±ä¹Ÿè´¡çŒ®äº†ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¼šæ¯”è¾ƒè¯¦ç»†ä¸€äº›ã€‚

ç›®å‰çš„æ—¶é—´æ˜¯2025å¹´5æœˆä¸­æ—¬ï¼Œè¿™é‡Œä¸»è¦è®°å½•çš„æ˜¯2024å¹´åº•é’ˆå¯¹ DeepSeek V3/R1 çš„ä¼˜åŒ–ï¼Œåœ¨è¿™ä¹‹å‰çš„ä¸€äº›ä¼˜åŒ–å¯èƒ½æ›´åŸºæ“ä¸€äº›ï¼Œå°±æ²¡æœ‰è®°å½•åˆ°ï¼Œæ„Ÿå…´è¶£å¯ä»¥å‚è€ƒä¸€ä¸‹SGLangä¹‹å‰æ¯”è¾ƒè€çš„ç‰ˆæœ¬çš„Release Blogä¹‹ç±»çš„ã€‚è¿™ä¸ªæ—¶é—´çº¿å…¶å®ä¹Ÿæ˜¯æˆ‘å‚ä¸SGLangå¼€æºçš„æ—¶é—´çº¿ï¼Œä¹‹å‰çš„æˆ‘ä¸æ˜¯å¾ˆç†Ÿæ‚‰å°±æ²¡å›çœ‹äº†ï¼Œå¹¶ä¸”åœ¨2024å¹´åº•å‰æ€§èƒ½ä¹Ÿä¸æ˜¯å¤ªå¼ºï¼Œå› ä¸ºæœ‰å¤ªå¤šå€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹äº†ã€‚ä¸‹é¢è®°å½•çš„ä¼˜åŒ–æœ‰å¤§æœ‰å°ï¼Œä½†æ˜¯éƒ½æ˜¯ä¸ºå•æœºè§„æ¨¡çš„DeepSeek V3/R1æ¨ç†æ€§èƒ½æå‡åšäº†è´¡çŒ®çš„ï¼Œå¦‚æœå¯¹åº”çš„ä¼˜åŒ–æ‰€åœ¨çš„PRæœ‰æ€§èƒ½æ•°æ®æˆ‘ä¹Ÿä¼šç®€å•æˆªå›¾ä¸€ä¸‹ã€‚éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œæ€§èƒ½æå‡æˆªå›¾æ˜¯æ§åˆ¶å˜é‡çš„æ–¹å¼åªçªå‡ºå½“å‰ä¼˜åŒ–çš„ä½œç”¨ï¼Œæ‰€ä»¥ä½ å¯ä»¥çœ‹åˆ°ä¸‹é¢ä¸åŒçš„å›¾æµ‹å‡ºæ¥çš„è¾“å‡ºååå·®å¼‚å¯èƒ½æ¯”å¤§ï¼Œè¿™ä¸ªæ˜¯æ­£å¸¸çš„å› ä¸ºmainåˆ†æ”¯åœ¨ä¸æ–­åˆå¹¶ä¼˜åŒ–å¯¼è‡´æ€§èƒ½åœ¨æå‡ï¼Œåªéœ€è¦å…³æ³¨å…·ä½“ä¼˜åŒ–çš„æœ‰æ•ˆæ€§å°±å¯ä»¥äº†ã€‚

ä¸‹é¢ç›´æ¥å¼€å§‹ï¼Œæˆ‘è®°å½•è¿™ä¸ªç¬”è®°æ˜¯æƒ³åˆ°å“ªé‡Œè®°å½•åˆ°å“ªé‡Œçš„ï¼Œå¹¶ä¸æ˜¯å®Œå…¨æŒ‰ç…§æ—¶é—´çš„å…ˆåé¡ºåºæ¥ã€‚

# 0x1. FP8 Block GEMM çš„æ¼”è¿›

DeepSeek V3/R1 ä¸­å•ç‹¬çš„Linearå¯¹åº”çš„forwardå°±æ˜¯FP8 Block GEMMï¼Œç»å†äº†3æ¬¡æ¼”è®²ã€‚é¦–å…ˆæ˜¯Tritonçš„å®ç°ï¼Œä»£ç ä»ä¿ç•™åœ¨è¿™é‡Œï¼šhttps://github.com/sgl-project/sglang/blob/main/python/sglang/srt/layers/quantization/fp8_kernel.py#L743 ï¼Œå½“ç„¶è¿™é‡Œä¹Ÿå­˜åœ¨å¯¹å„ç§å‚æ•°åœ¨å„ç§å¹³å°ä¸Šçš„è°ƒä¼˜ã€‚ç”±äºæ€§èƒ½æ¯”è¾ƒå·®ï¼Œåç»­æ¼”è¿›åˆ°ä½¿ç”¨äº†Cutlassçš„å®ç°ï¼Œå…·ä½“è§sgl-kernelä¸­çš„ï¼šhttps://github.com/sgl-project/sglang/blob/main/sgl-kernel/csrc/gemm/fp8_blockwise_gemm_kernel.cu ã€‚éšåï¼ŒDeepSeekçš„DEEPGEMMå¼€æºï¼ŒSGLangæ›´è¿›ä¸€æ­¥ä½¿ç”¨äº†DEEPGEMMçš„å®ç°ï¼Œå¹¶ä¸”è§£å†³å¥½äº†ç¼“å­˜JITç¼–è¯‘ç»“æœçš„é—®é¢˜ï¼Œå…·ä½“è§ï¼šhttps://github.com/sgl-project/sglang/blob/main/python/sglang/srt/layers/quantization/deep_gemm.py & https://github.com/sgl-project/sglang/blob/3e350a931e990c2b09cd18bc117ba219310bcda9/python/sglang/srt/layers/quantization/fp8_kernel.py#L784 ã€‚

ç°åœ¨SGLangä¸­é»˜è®¤å¼€å¯äº†DEEPGEMMï¼Œè¿™ä¸ªå®ç°ç›¸æ¯”äºsgl-kernelçš„cutlasså®ç°ï¼ŒTritonå®ç°åŸºæœ¬ä¸Šæ‰€æœ‰çš„caseä¸‹éƒ½æœ‰ä¼˜åŠ¿ï¼Œä½¿ç”¨é€»è¾‘æˆªå›¾ä¸‹ï¼š

![](https://files.mdnice.com/user/59/5fd75e1b-563a-4f17-a5fc-e37a86a643f9.png)

![](https://files.mdnice.com/user/59/e1da3949-0a2f-4f9a-a3e2-1461716d9ab7.png)

ç«¯åˆ°ç«¯çš„æå‡å¹…åº¦å’Œè¾“å…¥/è¾“å‡ºæ•°æ®é•¿çŸ­æœ‰å…³ç³»ï¼Œä¾‹å¦‚10k-500è¿™ç»„æ•°æ®è¾“å‡ºååç«¯åˆ°ç«¯æå‡5%ï¼Œ256-4kè¿™ç»„æ•°æ®è¾“å‡ºååç«¯åˆ°ç«¯æå‡10%ï¼Œè¿™é‡Œçš„æå‡æ˜¯ç›¸æ¯”äºsgl-kernel cutlasså®ç°æ¥è¯´çš„ã€‚

æ­¤å¤–ï¼ŒåŸºäºDeepGEMMï¼ŒSGLangè¿˜å°è¯•å°†æ¨¡å‹ä¸­çš„ä¸€ç³»åˆ—BMMè¿›è¡Œæ”¹å†™ï¼Œæ ¸å¿ƒideaæ˜¯ï¼š`per-token-group quant+deep_gemm's grouped_gemm_masked` æ¯” `per-tensor quant+bmm_fp8` æ›´å¿« (https://github.com/sgl-project/sglang/pull/5432) ã€‚ä¸è¿‡è¿™ä¸ªä¼˜åŒ–å¯èƒ½ä¼šå¯¼è‡´å‡†ç¡®ç‡å‡ºç°é—®é¢˜ï¼Œæ²¡æœ‰åœ¨ç”Ÿäº§ç¯å¢ƒä¸­é»˜è®¤ä½¿ç”¨ã€‚

# 0x2. FusedMoE æ¨¡å—çš„ä¼˜åŒ–

è¿™é‡Œåˆ†ç‚¹åˆ—ä¸€ä¸‹ã€‚

## 0x2.1 per_token_group_quant å’Œ moe_align_block_size çš„kernelä¼˜åŒ–

ä»£ç è§ï¼šhttps://github.com/sgl-project/sglang/blob/main/sgl-kernel/csrc/gemm/per_token_group_quant_8bit.cu & https://github.com/sgl-project/sglang/blob/main/sgl-kernel/csrc/moe/moe_align_kernel.cu ã€‚

è¿™ä¸¤ä¸ªæ“ä½œéƒ½æ˜¯FusedMoEæ¨¡å—çš„é¢„å¤„ç†éƒ¨åˆ†ï¼Œkernelæ•´ä½“å æ¯”æ²¡æœ‰å¾ˆå¤§ï¼Œéƒ½æ˜¯memory boundçš„kernelï¼Œä½†æ˜¯é€šè¿‡ä¼˜åŒ–å¯ä»¥æŠŠå•ä¸ªkernelçš„æ€§èƒ½éƒ½æå‡å¾ˆå¤šå€ã€‚å…·ä½“å¯ä»¥è§PRå¼€å‘æ—¶çš„micro benchmarkç»“æœï¼Œä¾‹å¦‚ï¼šhttps://github.com/sgl-project/sglang/pull/5086 ã€‚

è¿™ä¸ªä¹Ÿæ˜¯æˆ‘å…¥å‘SGLangå¼€æºçš„å¤´å‡ ä¸ªè´¡çŒ®ã€‚

## 0x2.2 biased_grouped_topk çš„ fuse kernel ä¼˜åŒ–

æˆ‘ä»¬åœ¨SGLangä¸­é’ˆå¯¹biased_grouped_topk(https://github.com/sgl-project/sglang/blob/main/python/sglang/srt/layers/moe/topk.py#L144)å¼•å…¥äº†ä¸€ä¸ªfuse cuda kernelçš„ä¼˜åŒ–ï¼Œå°†åå¤šä¸ªç®—å­fuseæˆä¸€ä¸ªcuda kernelå¤§å¤§æ”¹è¿›äº†grouped topkè¿™å—çš„æ€§èƒ½ã€‚ä¹‹å‰ä¹Ÿå†™äº†ä¸€ç¯‡blogä»‹ç»è¿™ä¸ªä¼˜åŒ–ï¼š[å›¾è§£DeepSeek V3 biased_grouped_topk cudaèåˆç®—å­fused_moe_gate kernel](https://mp.weixin.qq.com/s/p6LlY4sUBTy-Xfc9WumNSw) ï¼Œæ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚

![](https://files.mdnice.com/user/59/100d1c4f-a078-4a02-b290-c3bfd985edb4.png)

kernelå¯¹åº”çš„PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/4530

DeepSeek V3/R1 æ¨ç†æ€§èƒ½ç«¯åˆ°ç«¯æå‡æ˜¯5%-8%å·¦å³ã€‚

## 0x2.3 å°†Shared Expertså’ŒRoute Expertsèåˆ

å…·ä½“ç»†èŠ‚å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å†™çš„è¿™ç¯‡blogï¼Œè¿™ä¸ªä¼˜åŒ–èŠ±äº†æˆ‘æŒºå¤šæ—¶é—´å»æµ‹è¯•çš„ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæ¯”è¾ƒsolidæå‡ï¼Œ[åˆ†äº«ä¸€ä¸ªDeepSeek V3å’ŒR1ä¸­ Shared Expertså’Œæ™®é€šExpertsèåˆçš„ä¸€ä¸ªå°æŠ€å·§](https://mp.weixin.qq.com/s/Bz3qdkldULZiZ8ypooOX-A) ã€‚ä¸‹é¢æ˜¯ç«¯åˆ°ç«¯çš„æ€§èƒ½æå‡å›¾ï¼š

![](https://files.mdnice.com/user/59/2af2a88f-28a1-45e1-80f6-b004cd7ce744.png)

## 0x2.4 Triton Fused MoE Retuning

å‡çº§PyTorch Tritonç‰ˆæœ¬ä¹‹åç¤¾åŒºå°ä¼™ä¼´å‘ç°é‡æ–°Tuning fused MoE kernelä¹‹åå¯ä»¥å¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ï¼Œä¾‹å¦‚åœ¨Triton 3.2.0ä¸­å¦‚æœç»§ç»­å»¶ç”¨Triton 3.1.0 tuningçš„configï¼Œåˆ™æ€§èƒ½åè€Œä¼šä¸‹é™ï¼Œä½†å¦‚æœé‡æ–°Tuningåˆ™å¯ä»¥å–å¾—ç›¸æ¯”äºTriton 3.1.0æ›´å¥½çš„æ€§èƒ½ã€‚https://github.com/sgl-project/sglang/pull/5716 & https://github.com/sgl-project/sglang/pull/5740 ï¼Œé€šè¿‡é‡æ–°Tuning Fused MoE kernelï¼Œåœ¨DeepSeek V3/R1ä¸Šå–å¾—äº†æ€§èƒ½æå‡ã€‚

![](https://files.mdnice.com/user/59/cb3c8a78-8300-4b1b-b1ca-c098275e97fc.png)

æˆ‘è¿˜æµ‹è¯•äº†ä¸€ä¸‹Triton 3.2.0å‡çº§ä¸ºTriton 3.3.0çš„æå‡ï¼š

![](https://files.mdnice.com/user/59/ad528d83-80b5-42fc-8633-dca519786b99.png)

åŸºæœ¬ä¹Ÿæ˜¯ç¬¦åˆè¿™é‡Œçš„Retuningç»“è®ºçš„ã€‚ç„¶å https://github.com/vllm-project/vllm/pull/17934#issuecomment-2868822690 è¿™é‡Œçš„ä¸€ä¸ª micro benchmark æ€§èƒ½æµ‹è¯•ä¹Ÿä½è¯äº†è¿™ä¸€ç‚¹ã€‚

## 0x2.5 Fuse routed scaling factor in topk_reduce kernel

æŠŠexpertè®¡ç®—å®Œä¹‹åæœ€åä¹˜ä»¥routed_scaling_factorçš„é€»è¾‘fuseåˆ°Fused MoEæ¨¡å—çš„æœ€åé‚£ä¸ªtopk_reduce_sum kernelä¸­ï¼Œå…·ä½“å¯è§ï¼šhttps://github.com/sgl-project/sglang/pull/6220 ï¼Œç«¯åˆ°ç«¯æå‡å¦‚ä¸‹ï¼š

![](https://files.mdnice.com/user/59/9a8bb502-470d-4ec9-828d-2372b6b483cb.png)

## 0x2.6 ä¸€äº›é¢å¤–çš„æ¢ç´¢

åœ¨SGLangä¸­ä¹Ÿæ¢ç´¢äº†ä¸€ä¸‹TPæ¨¡å¼ä¸‹çš„åŸºäºCutlass Grouped GEMMå’ŒDEEPGEMMçš„fused moe kernelå®ç°ï¼Œå¹¶è·‘é€šäº†æ­£ç¡®æ€§æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ï¼Œä½†æ˜¯åœ¨TP8æ¨¡å¼ä¸‹ç›¸æ¯”äºDeepSeek V3/R1çš„Triton Fused MoE kernelæ²¡æœ‰çœ‹åˆ°æ€§èƒ½æå‡æ•ˆæœï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†ã€‚

# 0x3. Attention Backendçš„ä¼˜åŒ–

## 0x3.1 Flash Attention V3 Backend

æ¥è‡ªLinkedInçš„ä¼˜åŒ–ï¼Œè¯¦æƒ…å¯è§[åœ¨ SGLang ä¸­å®ç° Flash Attention åç«¯ - åŸºç¡€å’Œ KV ç¼“å­˜](https://mp.weixin.qq.com/s/693f008zNo7olXeSogy-sg) ï¼Œç«¯åˆ°ç«¯ååæå‡ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://files.mdnice.com/user/59/c0a5c601-1a75-4459-a1f3-43b4def58d80.png)

æ•ˆæœéå¸¸æ˜¾è‘—ï¼Œç„¶åSGLangç¤¾åŒºä¹Ÿåœ¨æ¨è¿›hybrid Attention Backendä»¥è·å¾—æ›´åŠ å¹¿æ³›çš„åŠ é€Ÿï¼Œå¯ä»¥å‚è€ƒï¼šhttps://github.com/sgl-project/sglang/pull/6151 ã€‚

## 0x3.2 Cutlass MLA attention backend & FlashMLA Attention Backend

PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5390 ï¼Œhttps://github.com/sgl-project/sglang/pull/4514 , https://github.com/sgl-project/sglang/pull/6034 ç­‰ç­‰ã€‚

è™½ç„¶æœ‰å¾ˆå¤šçš„Attention Backendå¯é€‰ï¼Œä¾‹å¦‚æœ€å¼€å§‹ç”¨çš„æ˜¯FlashInferçš„Backendï¼Œä¸è¿‡ç›®å‰SGLangé»˜è®¤ä½¿ç”¨äº†Flash Attention V3 Backendï¼Œè‡³å°‘åœ¨H200ä¸Šå¤§å¤šæ•°Caseä¸‹éƒ½æ‹¥æœ‰æœ€å¥½çš„æ€§èƒ½ã€‚

# 0x4. MLAçš„ä¼˜åŒ–

## 0x4.1 forward_absorb ä¸­å¤šä½™çš„copy

å¯¹åº”https://github.com/sgl-project/sglang/pull/5578ï¼Œè¿™ä¸ªä¼˜åŒ–ç§»é™¤äº†q_inputå’Œk_inputç­‰ä¸´æ—¶å˜é‡çš„åˆ›å»ºå’Œå¤„ç†ï¼Œå»æ‰äº†å¤šä¸ªæ¶‰åŠself.kv_lora_rankçš„å¤åˆ¶å’Œåˆ‡ç‰‡æ“ä½œã€‚ä¿®æ”¹å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://files.mdnice.com/user/59/02481ff0-5907-4bed-8829-93b1663390d3.png)

benchmarkç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://files.mdnice.com/user/59/68c505ad-a93e-4f76-a994-f3c59989803b.png)

## 0x4.2 MHAå’ŒMQAçš„é€‰æ‹©ç­–ç•¥ä¼˜åŒ–

æ¨èé˜…è¯»ï¼švLLMåœ¨Prefillé˜¶æ®µå’ŒDecodeé˜¶æ®µå¯¹MLAçš„ä¸åŒå®ç°çš„å¯¹æ¯”åˆ†æ(https://zhuanlan.zhihu.com/p/1897225385751585767) äº†è§£ideaçš„ç»†èŠ‚

è¿™ç¯‡æ–‡ç« é‡Œé¢æåˆ°MLAåœ¨ä¸€æ¬¡æ¨ç†ä¸­ï¼ŒPrefillé˜¶æ®µä½¿ç”¨çš„æ˜¯MHAå®ç°æ–¹å¼ï¼ŒDecodeé˜¶æ®µä½¿ç”¨çš„æ˜¯MQAçš„å®ç°æ–¹å¼ï¼Œä¸¤ç§ä¸åŒä¸»è¦æ˜¯Q * Kçš„çŸ©é˜µè®¡ç®—é¡ºåºä¸åŒå¸¦æ¥çš„å·®å¼‚ï¼Œæ‰€ä»¥çŸ©é˜µä¸éœ€è¦çœŸæ­£æ„ä¹‰ä¸Šçš„å¸æ”¶ï¼Œæ”¹å˜åªæ˜¯è®¡ç®—çš„é¡ºåºã€‚æ­¤å¤–ï¼Œåœ¨SGLangä¸­å¦‚æœè€ƒè™‘äº†Chunked Prefix Cacheï¼Œå¹¶ä¸”æ»¡è¶³batchä¸­æ‰€æœ‰åºåˆ—çš„prefixé•¿åº¦ä¹‹å’Œå¤§äºç­‰äºchunked_prefix_cache_thresholdï¼Œä»ç„¶ä½¿ç”¨MHAå®ç°æ–¹å¼ï¼ˆè¿™é‡Œæ˜¯`MHA_CHUNKED_KV`ï¼‰ã€‚å¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š

```python
elif self.attention_backend == "fa3":
    # Flash Attention: Use MHA with chunked KV cache when prefilling on long sequences.
    if forward_batch.extend_prefix_lens_cpu is not None:
        sum_extend_prefix_lens = sum(forward_batch.extend_prefix_lens_cpu)
    if (
        forward_batch.forward_mode.is_extend()
        and not self.disable_chunked_prefix_cache
        and not forward_batch.forward_mode.is_target_verify()
        and not forward_batch.forward_mode.is_draft_extend()
        and (
            sum_extend_prefix_lens >= self.chunked_prefix_cache_threshold
            or sum_extend_prefix_lens == 0
        )
    ):
        return AttnForwardMethod.MHA_CHUNKED_KV
    else:
        return AttnForwardMethod.MLA
```

è¯¦æƒ…å¯ä»¥å‚è€ƒï¼šhttps://github.com/sgl-project/sglang/pull/5113 ï¼Œä¹Ÿæ˜¯2025ä¸ŠåŠå¹´çš„ä¼˜åŒ– ã€‚ä¸‹é¢æ˜¯ä¸€äº›Benchmarkç»“æœæˆªå›¾ï¼š

![](https://files.mdnice.com/user/59/3943b0f8-5d6e-4356-9f09-4109d9cfd0e9.png)

å¯ä»¥çœ‹åˆ°å¯¹æ•´ä½“çš„ç«¯åˆ°ç«¯ååæå‡ä¹Ÿæ˜¯æ˜æ˜¾çš„ã€‚

## 0x4.3 Merge Attention States kernelä¼˜åŒ–

æ¥è‡ª @DefTruth(https://www.zhihu.com/people/qyjdef) çš„ kernel ä¼˜åŒ–ï¼Œä»–åœ¨çŸ¥ä¹ä¸Šä¹Ÿé’ˆå¯¹è¿™ä¸ªç®—å­å†™äº†å‡ ç¯‡blogï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹ï¼š

- [vLLMå®è·µ][ç®—å­]ğŸ“švLLMç®—å­å¼€å‘æµç¨‹: "ä¿å§†çº§"è¯¦ç»†è®°å½• (https://zhuanlan.zhihu.com/p/1892966682634473987)
- [Tritonç¼–ç¨‹][åŸºç¡€]ğŸ“švLLM Triton Merge Attention States Kernelè¯¦è§£ (https://zhuanlan.zhihu.com/p/1904937907703243110)

åœ¨SGLangä¸­çš„PRä¸ºï¼šhttps://github.com/sgl-project/sglang/pull/5381 ï¼ŒBenchmarkå¯ä»¥å‚è€ƒï¼šhttps://github.com/sgl-project/sglang/pull/5381#issue-2993195410

å¯¹æ•´ä½“çš„å½±å“æ¯”è¾ƒå°ï¼Œå› ä¸ºkernelçš„micro benchmarkæ˜¾ç¤ºæå‡æ™®éæ¯”è¾ƒæœ‰é™ï¼Œè¿™ä¸ªæ˜¯ç”¨åœ¨ä¸Šé¢ä»‹ç»åˆ°çš„MHA_CHUNKED_KVæ¨¡å¼ä¸‹ã€‚

## 0x4.4 Fuse q_a_proj å’Œ kv_a_proj 

è¿™ä¸ªä¼˜åŒ–å¯¹åº”çš„PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5619

åœ¨ DeepSeek v3 çš„è‡ªæ³¨æ„åŠ›æ¨¡å—ä¸­ï¼Œ`q_a_proj` å’Œ `kv_a_proj` éƒ½ä»¥éšè—çŠ¶æ€ä½œä¸ºè¾“å…¥ï¼Œå› æ­¤å®ƒä»¬å¯ä»¥è¢«èåˆæˆä¸€ä¸ªæ¨¡å—ï¼Œä»è€ŒèŠ‚çœä¸€æ¬¡ DeepGemm çš„å¯åŠ¨ã€‚å¯¹åº”çš„æ”¹åŠ¨æ˜¯ï¼šå½“ `q_lora_rank` å¤§äº 0 æ—¶(è¿™å¯¹ DeepSeek V3 å’Œ R1 æ¥è¯´æ˜¯æˆç«‹çš„), `self.q_a_proj` å’Œ `self.kv_a_proj_with_mqa` ä¼šè¢«èåˆæˆä¸€ä¸ªæ–°çš„æ¨¡å— `self.fused_qkv_a_proj_with_mqa`ã€‚åœ¨åŠ è½½æƒé‡æ—¶,`q_a_proj` å’Œ `kv_a_proj` çš„æƒé‡å’Œ block scales ä¼šè¢«æ‹¼æ¥å¹¶åŠ è½½åˆ° `self.fused_qkv_a_proj_with_mqa` ä¸­ã€‚benchmarkç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://files.mdnice.com/user/59/df52ff70-9f99-4554-895b-190a90eaa2d2.png)

å¯¹äºbs=1æ—¶æå‡äº†çº¦4.2%ï¼Œå¯¹äºbs=32æ—¶æå‡äº†çº¦3.8%ã€‚

## 0x4.5 Fuse MLA set kv cache kernel 

è¿™ä¸ªä¼˜åŒ–å¯¹åº”çš„PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5748

å®ƒåšçš„äº‹æƒ…æ˜¯èåˆ MLA set kv cache kernel å¹¶ç§»é™¤ k concat æ“ä½œã€‚ç›®å‰ä»…æ”¯æŒ FA3 åç«¯ã€‚åç»­éªŒè¯åå¯ä»¥åº”ç”¨åˆ°å…¶ä»–åç«¯ã€‚

![](https://files.mdnice.com/user/59/5502f5e3-b484-4d75-b06f-f149d563b156.png)

# 0x5. DeepSeek V3/R1 å…¶å®ƒçš„ä¼˜åŒ–æŠ€å·§è®°å½•

## 0x5.1 Overlap qk norm with two streams

é€šè¿‡2ä¸ªCUDA StreamæŠŠDeepSeek V3/R1 Attention éƒ¨åˆ†çš„ `forward_absorb` å®ç°ä¸­å¯¹q, kåˆ†åˆ«åšrmsnormçš„æ— æ•°æ®ä¾èµ–çš„æ“ä½œoverlapèµ·æ¥ã€‚PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5977

![](https://files.mdnice.com/user/59/48878ec7-a76d-4b76-8427-fc27308fda5f.png)

## 0x5.2 å±‚é—´å¤ç”¨çš„ BumpAllocator

è¿™é‡Œçš„å‡ºå‘ç‚¹æ˜¯æ¯ä¸€å±‚Layeræˆ‘ä»¬éƒ½è¦åšè¾“å…¥åšé‡åŒ–ï¼Œç„¶ååšé‡åŒ–çš„æ—¶å€™éƒ½éœ€è¦ç»™é‡åŒ–ç®—å­ç”³è¯·ä¸€ä¸ªæ–°çš„zero scalar tensorï¼Œä¸ºäº†é¿å…é‡å¤ç”³è¯·Tomåšäº†ä¸€ä¸ªBumpAllocatorï¼Œè¾¾åˆ°å¯ä»¥å±‚é—´å†…å­˜å¤ç”¨çš„ç›®çš„ï¼Œå‡å°‘ä¸åŒå±‚é‡å¤åˆ›å»ºtorch.zerosçš„ç›®çš„ã€‚PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5549

![](https://files.mdnice.com/user/59/dba6d83c-23ff-4357-839c-2e42b218faad.png)

## 0x5.3 ä½¿ç”¨sgl-kernel çš„ sglang_per_token_group_quant_fp8 ç®—å­è€Œä¸æ˜¯Tritonå®ç°

PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5473

![](https://files.mdnice.com/user/59/f6f7ce1b-8e28-4019-a64d-906eadf8f2c7.png)

## 0x5.4 åœ¨DeepSeek V3/R1 åº”ç”¨cuda rope

PRè§ï¼šhttps://github.com/sgl-project/sglang/pull/5385

![](https://files.mdnice.com/user/59/7aec31c8-a1b1-434f-9885-40fe9d8f03b4.png)

## 0x5.5 ä¼˜åŒ– MLA çš„ fp8 quant kernel

è¿™ä¸ªä¼˜åŒ–çš„å‡ºå‘ç‚¹æ˜¯ä¸‹é¢è¿™å¼ å›¾å³ä¸Šè§’çš„bmmè¦ç”¨deepgemmæˆ–è€…cutlass fp8 `bmm` æ¥åšï¼Œæ‰€ä»¥éœ€è¦æŠŠè¾“å…¥ä»bf16è½¬æ¢ä¸ºfp8ã€‚

![](https://files.mdnice.com/user/59/2b2580b4-f034-4f92-b52c-286335a0f56c.jpg)

ä¾‹å¦‚æˆ‘ä»¬ä»¥deepgemm bmmä¸ºä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```python
q_nope, q_pe = q.split([self.qk_nope_head_dim, self.qk_rope_head_dim], dim=-1)
k_pe = latent_cache[..., self.kv_lora_rank :].unsqueeze(1)

if self.use_deep_gemm_bmm:
    q_nope_val, q_nope_scale, masked_m, expected_m, aligned_m = (
        per_token_group_quant_mla_deep_gemm_masked_fp8(q_nope.transpose(0, 1))
    )
    q_nope_out = q_nope.new_empty(
        (self.num_local_heads, aligned_m, self.kv_lora_rank)
    )
    deep_gemm_grouped_gemm_nt_f8f8bf16_masked(
        (q_nope_val, q_nope_scale),
        (self.w_kc, self.w_scale_k),
        q_nope_out,
        masked_m,
        expected_m,
    )
    q_nope_out = q_nope_out[:, :expected_m, :]
```

è¿™ä¸ªPRåšçš„äº‹æƒ…å°±æ˜¯ç”¨Tritonå®ç°äº†ä¸€ä¸ª`per_token_group_quant_mla_deep_gemm_masked_fp8` kernelï¼Œåœ¨è¿™ä¹‹å‰è¿™ä¸ªæ“ä½œæ˜¯ç”±ä¸€å †å°ç®—å­ç»„æˆçš„ï¼Œæ‰€ä»¥è¿™ä¸ªä¹Ÿæ˜¯CUDA kernel fuseçš„æŠ€å·§ï¼Œä¸ºäº†æ–¹ä¾¿è¿™é‡Œæ˜¯ç›´æ¥ç”¨Tritonå®ç°äº†ä¸€ä¸ªkernelã€‚

![](https://files.mdnice.com/user/59/ed8f1240-7882-4f27-b176-d86ec1185402.png)

## 0x5.6 
